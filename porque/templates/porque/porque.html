{% extends 'miapp/base.html' %}

{% block title %}5 POR QUÉ{% endblock %}

{% block content %}
<div class="form-container">
    <h1 id="analisis-5w" class="text-center">5 POR QUÉ</h1>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Formulario Unificado -->
    <form method="post" class="analisis-5w-form" id="form" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- Paso 0: Inscripción -->
        <div class="form-row">
            <div class="form-group col-md-6">
                {{ form.categoria.label_tag }}
                {{ form.categoria }}
            </div>
            <div class="form-group col-md-6">
                {{ form.subcategoria.label_tag }}
                {{ form.subcategoria }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-6">
                {{ form.area.label_tag }}
                {{ form.area }}
            </div>
            <div class="form-group col-md-6">
                {{ form.subarea.label_tag }}
                {{ form.subarea }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-6">
                {{ form.maquina.label_tag }}
                {{ form.maquina }}
            </div>
            <div class="form-group col-md-6">
                {{ form.miembros_equipo.label_tag }}
                <select id="miembros_equipo" name="miembros_equipo" class="form-control" multiple>
                    {% for miembro in opciones_miembros %}
                        <option value="{{ miembro.id }}" data-email="{{ miembro.email }}">
                            {{ miembro.nombre }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-6">
                {{ form.pilar.label_tag }}
                {{ form.pilar }}
            </div>
            <div class="form-group col-md-6">
                {{ form.impacto.label_tag }}
                {{ form.impacto }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-6">
                {{ form.kpi_iceo.label_tag }}
                {{ form.kpi_iceo }}
            </div>
            <div class="form-group col-md-6">
                {{ form.kpi_secundario.label_tag }}
                {{ form.kpi_secundario }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-6">
                {{ form.fecha_inicio.label_tag }}
                {{ form.fecha_inicio }}
            </div>
            <div class="form-group col-md-6">
                {{ form.fecha_cierre.label_tag }}
                {{ form.fecha_cierre }}
            </div>
        </div>

        <!-- Paso 1 -->
        <h2 class="text-danger">Paso 1: Descripción del Problema</h2>
        <div class="form-row">
            <div class="form-group col-md-12">
                {{ form.que_ocurre.label_tag }}
                {{ form.que_ocurre }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-12">
                {{ form.como_ocurre.label_tag }}
                {{ form.como_ocurre }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-12">
                {{ form.donde_ocurre.label_tag }}
                {{ form.donde_ocurre }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-12">
                {{ form.cuando_ocurre.label_tag }}
                {{ form.cuando_ocurre }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-12">
                {{ form.quien_presente.label_tag }}
                {{ form.quien_presente }}
            </div>
        </div>

        <!-- Señal antes de que ocurra el problema -->
        <h2 class="text-danger">Señal antes de que ocurra el problema</h2>
        <div class="form-row">
            <div class="form-group col-md-6">
                {{ form.senal_antes.label_tag }}
                {{ form.senal_antes }}
            </div>
            <div class="form-group col-md-6">
                {{ form.descripcion_senal.label_tag }}
                {{ form.descripcion_senal }}
            </div>
        </div>

        <!-- Falla funcional -->
        <h2 class="text-danger">Falla funcional</h2>
        <div class="form-row">
            <div class="form-group col-md-12">
                {{ form.falla_funcional.label_tag }}
                {{ form.falla_funcional }}
            </div>
            <div class="form-group col-md-6">
                {{ form.imagen_falla_funcional.label_tag }}
                {{ form.imagen_falla_funcional }}
            </div>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar y Continuar</button>
        </div>
    </form>
</div>

<!-- Incluir Select2 y jQuery -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Inicialización de Select2 y otros scripts para ambos formularios -->
<script type="text/javascript">
    $(document).ready(function() {
        // Formateo de opciones de Select2
        function formatState(state) {
            if (!state.id) {
                return state.text;
            }
            var email = $(state.element).data('email');
            var $state = $('<span><strong>' + state.text + '</strong><br/><small>' + email + '</small></span>');
            return $state;
        }

        // Inicializar Select2 para miembros del equipo
        $('#miembros_equipo').select2({
            placeholder: "Selecciona miembros del equipo",
            templateResult: formatState,
            templateSelection: formatState,
            allowClear: true
        });

        // Mapeo de subcategorías para categorías, pilar y KPI ICEO
        const mappings = {
            "Microbiología": {
                categoria: "CALIDAD",
                pilar: "Pilar Calidad",
                kpi_iceo: "Calidad de procesos"
            },
            "Break Down": {
                categoria: "OPINONA",
                pilar: "Pilar CA/MA",
                kpi_iceo: "OPINONA"
            }
        };

        // Función para actualizar los valores en el formulario
        function actualizarValoresForm(subcategoria) {
            if (mappings[subcategoria]) {
                $("#form_categoria").val(mappings[subcategoria].categoria);
                $("#form_pilar").val(mappings[subcategoria].pilar);
                $("#form_kpi_iceo").val(mappings[subcategoria].kpi_iceo);
            } else {
                $("#form_categoria").val('');
                $("#form_pilar").val('');
                $("#form_kpi_iceo").val('');
            }
        }

        // Evento de cambio para subcategoría en el formulario
        $("#subcategoria").change(function() {
            const subcategoria = $(this).val();
            actualizarValoresForm(subcategoria);
        });

        // Configurar la fecha actual en el campo Fecha Inicio del formulario
        var today = new Date();
        var day = ("0" + today.getDate()).slice(-2);
        var month = ("0" + (today.getMonth() + 1)).slice(-2);
        var todayFormatted = today.getFullYear() + "-" + month + "-" + day;
        $('#form_fecha_inicio').val(todayFormatted);
    });
</script>
{% endblock %}
