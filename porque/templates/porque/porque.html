{% extends 'miapp/base.html' %}

{% block title %}5 POR QUÉ{% endblock %}

{% block content %}
<div class="form-container">
    <h1 id="analisis-5w" class="text-center">5 POR QUÉ</h1>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Formulario Unificado -->
    <form method="post" class="analisis-5w-form" id="form" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Sección Paso 0: Datos iniciales -->
        <div id="seccion1" class="recuadro-paso">
            <h2 class="text-primary">Paso 0: Datos Iniciales</h2>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="categoria">Categoría</label>
                    <input type="text" id="categoria" name="categoria" class="form-control" value="{{ form.categoria.value }}" readonly>
                </div>
                <div class="form-group col-md-6">
                    <label for="subcategoria">Subcategoría</label>
                    <select id="subcategoria" name="subcategoria" class="form-control">
                        <option value="">Seleccione una subcategoría</option>
                        <option value="Microbiología" {% if form.subcategoria.value == "Microbiología" %}selected{% endif %}>Microbiología</option>
                        <option value="Break Down" {% if form.subcategoria.value == "Break Down" %}selected{% endif %}>Break Down</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="area">Área</label>
                    <select id="area" name="area" class="form-control">
                        <option value="">Seleccione un área</option>
                        {% for opcion in opciones_area %}
                            <option value="{{ opcion }}" {% if form.area.value == opcion %}selected{% endif %}>{{ opcion }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-6">
                    <label for="subarea">Subárea</label>
                    <select id="subarea" name="subarea" class="form-control">
                        <option value="">Seleccione una línea</option>
                        {% for opcion in opciones_subarea %}
                            <option value="{{ opcion }}" {% if form.subarea.value == opcion %}selected{% endif %}>{{ opcion }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="maquina">Máquina</label>
                    <select id="maquina" name="maquina" class="form-control">
                        <option value="">Seleccione una máquina</option>
                        {% for opcion in opciones_maquina %}
                            <option value="{{ opcion }}" {% if form.maquina.value == opcion %}selected{% endif %}>{{ opcion }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-md-6">
                    <label for="miembros_equipo">Miembros del equipo</label>
                    <select id="miembros_equipo" name="miembros_equipo" class="form-control select2" multiple>
                        {% for miembro in opciones_miembros %}
                            <option value="{{ miembro.id }}" data-email="{{ miembro.email }}" {% if miembro.id in form.miembros_equipo.value %}selected{% endif %}>
                                {{ miembro.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="pilar">Pilar</label>
                    <input type="text" id="pilar" name="pilar" class="form-control" value="{{ form.pilar.value }}" readonly>
                </div>
                <div class="form-group col-md-6">
                    <label for="impacto">Impacto</label>
                    <input type="text" id="impacto" name="impacto" class="form-control" value="{{ form.impacto.value }}">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="kpi_iceo">KPI ICEO</label>
                    <input type="text" id="kpi_iceo" name="kpi_iceo" class="form-control" value="{{ form.kpi_iceo.value }}" readonly>
                </div>
                <div class="form-group col-md-6">
                    <label for="kpi_secundario">KPI Secundario (KAI)</label>
                    <select id="kpi_secundario" name="kpi_secundario" class="form-control">
                        <option value="">Seleccione un KPI secundario</option>
                        <option value="kpi1" {% if form.kpi_secundario.value == "kpi1" %}selected{% endif %}>Eficiencia Global de Equipos (OEE)</option>
                        <option value="kpi2" {% if form.kpi_secundario.value == "kpi2" %}selected{% endif %}>Tasa de Defectos</option>
                        <option value="kpi3" {% if form.kpi_secundario.value == "kpi3" %}selected{% endif %}>Tiempo Medio Entre Fallos (MTBF)</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                {% if not form.instance.pk %}
                <div class="form-group col-md-6">
                    <label for="fecha_inicio">Fecha Inicio</label>
                    <input type="date" id="fecha_inicio" name="fecha_inicio" class="form-control" value="{{ form.fecha_inicio.value }}" readonly>
                </div>
                {% endif %}
                <div class="form-group col-md-6">
                    <label for="fecha_cierre">Fecha Estimada de Cierre</label>
                    <input type="date" id="fecha_cierre" name="fecha_cierre" class="form-control" value="{{ form.fecha_cierre.value|date:'Y-m-d' }}">
                </div>
            </div>
        </div>

        <!-- Sección Paso 1: Descripción del Problema (visible después del Paso 0) -->
        {% if mostrar_paso1 %}
        <div id="paso1-section" class="recuadro-paso mt-4" style="border: 1px solid #ff0000;">
            <div class="paso-header" style="background-color: #ff0000; color: white; padding: 10px 15px; border-radius: 5px;">
                <h2 class="collapsible" style="cursor: pointer; margin: 0;" onclick="toggleVisibility('contenido-paso1')">
                    <span style="margin-right: 10px;">&#x25BC;</span> Paso 1: Descripción del Problema
                </h2>
            </div>
            <div id="contenido-paso1">
                <div class="form-row">
                    <div class="form-group col-md-12">
                        {{ form.que_ocurre.label_tag }}
                        {{ form.que_ocurre }}
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-12">
                        {{ form.como_ocurre.label_tag }}
                        {{ form.como_ocurre }}
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-12">
                        {{ form.donde_ocurre.label_tag }}
                        {{ form.donde_ocurre }}
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-12">
                        {{ form.cuando_ocurre.label_tag }}
                        {{ form.cuando_ocurre }}
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-12">
                        {{ form.quien_presente.label_tag }}
                        {{ form.quien_presente }}
                    </div>
                </div>

                <!-- Señal antes de que ocurra el problema -->
                <h2 class="text-danger">Señal antes de que ocurra el problema</h2>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        {{ form.senal_antes.label_tag }}
                        {{ form.senal_antes }}
                    </div>
                    <div class="form-group col-md-6">
                        {{ form.descripcion_senal.label_tag }}
                        {{ form.descripcion_senal }}
                    </div>
                </div>

                <!-- Falla funcional -->
                <h2 class="text-danger">Falla funcional</h2>
                <div class="form-row">
                    <div class="form-group col-md-12">
                        {{ form.falla_funcional.label_tag }}
                        {{ form.falla_funcional }}
                    </div>
                    <div class="form-group col-md-6">
                        {{ form.imagen_falla_funcional.label_tag }}
                        {{ form.imagen_falla_funcional }}
                    </div>
                </div>
            </div>
        </div>
        

        <!-- Sección Paso 2: Comprender y Restaurar Condiciones Básicas -->
        <div id="paso2-section" class="recuadro-paso mt-4" style="border: 1px solid #e6007e;">
            <div class="paso-header" style="background-color: #e6007e; color: white; padding: 10px 15px; border-radius: 5px;">
                <h2 class="collapsible" style="cursor: pointer; margin: 0;" onclick="toggleVisibility('contenido-paso2')">
                    <span style="margin-right: 10px;">&#x25BC;</span> Paso 2: Comprender y Restaurar Condiciones Básicas
                </h2>
            </div>
            <div id="contenido-paso2">
                
                <!-- Bloque 1: Principio de funcionamiento -->
                <div class="sub-section" style="margin-bottom: 20px;">
                    <div class="sub-header" style="background-color: #e6007e; color: white; padding: 10px 15px; border-radius: 5px;">
                        <h3 style="margin: 0;">Principio de funcionamiento</h3>
                    </div>
                    <div class="sub-content" style="padding: 10px; border: 1px solid #e6007e; border-radius: 5px;">
                        <div class="form-row">
                            <div class="form-group col-md-12">
                                {{ form.principio_funcionamiento.label_tag }}
                                {{ form.principio_funcionamiento }}
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-12">
                                {{ form.imagen_funcionamiento.label_tag }}
                                {{ form.imagen_funcionamiento }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bloque 2: Restablecimiento de condiciones básicas y verificación de herramientas -->
                <div class="sub-section" style="margin-bottom: 20px;">
                    <div class="sub-header" style="background-color: #e6007e; color: white; padding: 10px 15px; border-radius: 5px;">
                        <h3 style="margin: 0;">Restablecimiento de condiciones básicas y verificación de herramientas</h3>
                    </div>
                    <div class="sub-content" style="padding: 10px; border: 1px solid #e6007e; border-radius: 5px;">
                        <div class="form-group">
                            <label>{{ form.tarjetas_atrasadas.label }}</label>
                            <div class="d-inline-block">
                                {{ form.tarjetas_atrasadas }}
                            </div>
                        </div>
                        <div class="form-group">
                            <label>{{ form.lila_asociado.label }}</label>
                            <div>
                                {{ form.lila_asociado }}
                            </div>
                        </div>
                        <div class="form-group">
                            <label>{{ form.ejecuto_lila.label }}</label>
                            <div>
                                {{ form.ejecuto_lila }}
                            </div>
                        </div>
                        <div class="form-group">
                            <label>{{ form.mantenimiento_no_ejecutado.label }}</label>
                            <div>
                                {{ form.mantenimiento_no_ejecutado }}
                            </div>
                        </div>
                        <div class="form-group">
                            <label>{{ form.materiales_calidad.label }}</label>
                            <div>
                                {{ form.materiales_calidad }}
                            </div>
                        </div>                        
                    </div>
                </div>

                <!-- Bloque 3: Modo de Falla -->
                <div class="sub-section" style="margin-bottom: 20px;">
                    <div class="sub-header" style="background-color: #e6007e; color: white; padding: 10px 15px; border-radius: 5px;">
                        <h3 style="margin: 0;">Modo de Falla</h3>
                    </div>
                    <div class="sub-content" style="padding: 10px; border: 1px solid #e6007e; border-radius: 5px;">
                        <div class="form-row">
                            <div class="form-group col-md-12">
                                {{ form.modo_falla_paso2.label_tag }}
                                {{ form.modo_falla_paso2 }}
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-12">
                                {{ form.imagen_falla.label_tag }}
                                {{ form.imagen_falla }}
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Sección Paso 3: Causa Raíz -->

        
























<div id="paso3-section" class="recuadro-paso mt-4" style="border: 1px solid #FFC800;">
    <div class="paso-header" style="background-color: #FFC800; color: white; padding: 10px 15px; border-radius: 5px;">
        <h2 class="collapsible" style="cursor: pointer; margin: 0;" onclick="toggleVisibility('contenido-paso3')">
            <span style="margin-right: 10px;">▼</span> Paso 3: Causa Raíz
        </h2>
    </div>

    <div id="contenido-paso3">
        <div><h1></h1></div>
        <button id="addPorqueBtn" type="button" class="btn btn-primary mb-3">
            {% if form.porque6.value %}Agregar POR QUÉ?{% else %}Agregar POR QUÉ?{% endif %}
        </button>
        <button id="showMoreRows" type="button" class="btn btn-secondary mb-3">Mostrar más filas</button>

        <table id="porqueTable">
            <tr>
                <th>Modo de Falla</th>
                <th>¿POR QUÉ? (1)</th>
                <th></th>
                <th>¿POR QUÉ? (2)</th>
                <th></th>
                <th>¿POR QUÉ? (3)</th>
                <th></th>
                <th>¿POR QUÉ? (4)</th>
                <th></th>
                <th>¿POR QUÉ? (5)</th>
                <th></th>
                <th class="porque6-col" {% if not form.porque6.value %}style="display: none;"{% endif %}>¿POR QUÉ? (6)</th>
                <th class="validacion6-col" {% if not form.porque6.value %}style="display: none;"{% endif %}></th>
                <th class="porque7-col" {% if not form.porque7.value %}style="display: none;"{% endif %}>¿POR QUÉ? (7)</th>
                <th class="validacion7-col" {% if not form.porque7.value %}style="display: none;"{% endif %}></th>
                <th>Raíz</th>
            </tr>

            <!-- Primeras 4 filas visibles -->
            <tr id="porque-row">
                <td>{{ form.modo_falla_paso3 }}</td>
                <td>{{ form.porque1 }}</td>
                <td class="color-cell form-control validacion-celda" data-color="{{ form.color_validacion1.value }}" onclick="changeColor(this, 'color_validacion1')">
                    {{ form.color_validacion1 }}
                </td>
                <td>{{ form.porque2 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion2.value }}" onclick="changeColor(this, 'color_validacion2')">
                    {{ form.color_validacion2 }}
                </td>
                <td>{{ form.porque3 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion3.value }}" onclick="changeColor(this, 'color_validacion3')">
                    {{ form.color_validacion3 }}
                </td>
                <td>{{ form.porque4 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion4.value }}" onclick="changeColor(this, 'color_validacion4')">
                    {{ form.color_validacion4 }}
                </td>
                <td>{{ form.porque5 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion5.value }}" onclick="changeColor(this, 'color_validacion5')">
                    {{ form.color_validacion5 }}
                </td>
                <td class="porque6-col" {% if not form.porque6.value %}style="display: none;"{% endif %}>{{ form.porque6 }}</td>
                <td class="color-cell validacion6-col" {% if not form.porque6.value %}style="display: none;"{% endif %} data-color="{{ form.color_validacion6.value }}" onclick="changeColor(this, 'color_validacion6')">
                    {{ form.color_validacion6 }}
                </td>
                <td class="porque7-col" {% if not form.porque7.value %}style="display: none;"{% endif %}>{{ form.porque7 }}</td>
                <td class="color-cell validacion7-col" {% if not form.porque7.value %}style="display: none;"{% endif %} data-color="{{ form.color_validacion7.value }}" onclick="changeColor(this, 'color_validacion7')">
                    {{ form.color_validacion7 }}
                </td>
                <td>{{ form.Raiz }}</td>
            </tr>

            <tr id="porque-row-2" style="display: none;">
                <td>{{ form.modo_falla_paso3_2 }}</td>
                <td>{{ form.porque1_2 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion1_2.value }}" onclick="changeColor(this, 'color_validacion1_2')">
                    {{ form.color_validacion1_2 }}
                </td>
                <td>{{ form.porque2_2 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion2_2.value }}" onclick="changeColor(this, 'color_validacion2_2')">
                    {{ form.color_validacion2_2 }}
                </td>
                <td>{{ form.porque3_2 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion3_2.value }}" onclick="changeColor(this, 'color_validacion3_2')">
                    {{ form.color_validacion3_2 }}
                </td>
                <td>{{ form.porque4_2 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion4_2.value }}" onclick="changeColor(this, 'color_validacion4_2')">
                    {{ form.color_validacion4_2 }}
                </td>
                <td>{{ form.porque5_2 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion5_2.value }}" onclick="changeColor(this, 'color_validacion5_2')">
                    {{ form.color_validacion5_2 }}
                </td>
                <td class="porque6-col" {% if not form.porque6_2.value %}style="display: none;"{% endif %}>{{ form.porque6_2 }}</td>
                <td class="color-cell validacion6-col" {% if not form.porque6_2.value %}style="display: none;"{% endif %} data-color="{{ form.color_validacion6_2.value }}" onclick="changeColor(this, 'color_validacion6_2')">
                    {{ form.color_validacion6_2 }}
                </td>
                <td class="porque7-col" {% if not form.porque7_2.value %}style="display: none;"{% endif %}>{{ form.porque7_2 }}</td>
                <td class="color-cell validacion7-col" {% if not form.porque7_2.value %}style="display: none;"{% endif %} data-color="{{ form.color_validacion7_2.value }}" onclick="changeColor(this, 'color_validacion7_2')">
                    {{ form.color_validacion7_2 }}
                </td>
                <td>{{ form.Raiz_2 }}</td>
            </tr>

            <tr id="porque-row-3" style="display: none;">
                <td>{{ form.modo_falla_paso3_3 }}</td>
                <td>{{ form.porque1_3 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion1_3.value }}" onclick="changeColor(this, 'color_validacion1_3')">
                    {{ form.color_validacion1_3 }}
                </td>
                <td>{{ form.porque2_3 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion2_3.value }}" onclick="changeColor(this, 'color_validacion2_3')">
                    {{ form.color_validacion2_3 }}
                </td>
                <td>{{ form.porque3_3 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion3_3.value }}" onclick="changeColor(this, 'color_validacion3_3')">
                    {{ form.color_validacion3_3 }}
                </td>
                <td>{{ form.porque4_3 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion4_3.value }}" onclick="changeColor(this, 'color_validacion4_3')">
                    {{ form.color_validacion4_3 }}
                </td>
                <td>{{ form.porque5_3 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion5_3.value }}" onclick="changeColor(this, 'color_validacion5_3')">
                    {{ form.color_validacion5_3 }}
                </td>
                <td class="porque6-col" {% if not form.porque6_3.value %}style="display: none;"{% endif %}>{{ form.porque6_3 }}</td>
                <td class="color-cell validacion6-col" {% if not form.porque6_3.value %}style="display: none;"{% endif %} data-color="{{ form.color_validacion6_3.value }}" onclick="changeColor(this, 'color_validacion6_3')">
                    {{ form.color_validacion6_3 }}
                </td>
                <td class="porque7-col" {% if not form.porque7_3.value %}style="display: none;"{% endif %}>{{ form.porque7_3 }}</td>
                <td class="color-cell validacion7-col" {% if not form.porque7_3.value %}style="display: none;"{% endif %} data-color="{{ form.color_validacion7_3.value }}" onclick="changeColor(this, 'color_validacion7_3')">
                    {{ form.color_validacion7_3 }}
                </td>
                <td>{{ form.Raiz_3 }}</td>
            </tr>

            <tr id="porque-row-4" style="display: none;">
                <td>{{ form.modo_falla_paso3_4 }}</td>
                <td>{{ form.porque1_4 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion1_4.value }}" onclick="changeColor(this, 'color_validacion1_4')">
                    {{ form.color_validacion1_4 }}
                </td>
                <td>{{ form.porque2_4 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion2_4.value }}" onclick="changeColor(this, 'color_validacion2_4')">
                    {{ form.color_validacion2_4 }}
                </td>
                <td>{{ form.porque3_4 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion3_4.value }}" onclick="changeColor(this, 'color_validacion3_4')">
                    {{ form.color_validacion3_4 }}
                </td>
                <td>{{ form.porque4_4 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion4_4.value }}" onclick="changeColor(this, 'color_validacion4_4')">
                    {{ form.color_validacion4_4 }}
                </td>
                <td>{{ form.porque5_4 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion5_4.value }}" onclick="changeColor(this, 'color_validacion5_4')">
                    {{ form.color_validacion5_4 }}
                </td>
                <td class="porque6-col" {% if not form.porque6_4.value %}style="display: none;"{% endif %}>{{ form.porque6_4 }}</td>
                <td class="color-cell validacion6-col" {% if not form.porque6_4.value %}style="display: none;"{% endif %} data-color="{{ form.color_validacion6_4.value }}" onclick="changeColor(this, 'color_validacion6_4')">
                    {{ form.color_validacion6_4 }}
                </td>
                <td class="porque7-col" {% if not form.porque7_4.value %}style="display: none;"{% endif %}>{{ form.porque7_4 }}</td>
                <td class="color-cell validacion7-col" {% if not form.porque7_4.value %}style="display: none;"{% endif %} data-color="{{ form.color_validacion7_4.value }}" onclick="changeColor(this, 'color_validacion7_4')">
                    {{ form.color_validacion7_4 }}
                </td>
                <td>{{ form.Raiz_4 }}</td>
            </tr>

            <!-- Filas 5 a 8 ocultas inicialmente -->
            <tr id="porque-row-5" style="display: none;">
                <td>{{ form.modo_falla_paso3_5 }}</td>
                <td>{{ form.porque1_5 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion1_5.value }}" onclick="changeColor(this, 'color_validacion1_5')">
                    {{ form.color_validacion1_5 }}
                </td>
                <td>{{ form.porque2_5 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion2_5.value }}" onclick="changeColor(this, 'color_validacion2_5')">
                    {{ form.color_validacion2_5 }}
                </td>
                <td>{{ form.porque3_5 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion3_5.value }}" onclick="changeColor(this, 'color_validacion3_5')">
                    {{ form.color_validacion3_5 }}
                </td>
                <td>{{ form.porque4_5 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion4_5.value }}" onclick="changeColor(this, 'color_validacion4_5')">
                    {{ form.color_validacion4_5 }}
                </td>
                <td>{{ form.porque5_5 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion5_5.value }}" onclick="changeColor(this, 'color_validacion5_5')">
                    {{ form.color_validacion5_5 }}
                </td>
                <td class="porque6-col" {% if not form.porque6_5.value %}style="display: none;"{% endif %}>{{ form.porque6_5 }}</td>
                <td class="color-cell validacion6-col" {% if not form.porque6_5.value %}style="display: none;"{% endif %} data-color="{{ form.color_validacion6_5.value }}" onclick="changeColor(this, 'color_validacion6_5')">
                    {{ form.color_validacion6_5 }}
                </td>
                <td class="porque7-col" {% if not form.porque7_5.value %}style="display: none;"{% endif %}>{{ form.porque7_5 }}</td>
                <td class="color-cell validacion7-col" {% if not form.porque7_5.value %}style="display: none;"{% endif %} data-color="{{ form.color_validacion7_5.value }}" onclick="changeColor(this, 'color_validacion7_5')">
                    {{ form.color_validacion7_5 }}
                </td>
                <td>{{ form.Raiz_5 }}</td>
            </tr>

            <tr id="porque-row-6" style="display: none;">
                <td>{{ form.modo_falla_paso3_6 }}</td>
                <td>{{ form.porque1_6 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion1_6.value }}" onclick="changeColor(this, 'color_validacion1_6')">
                    {{ form.color_validacion1_6 }}
                </td>
                <td>{{ form.porque2_6 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion2_6.value }}" onclick="changeColor(this, 'color_validacion2_6')">
                    {{ form.color_validacion2_6 }}
                </td>
                <td>{{ form.porque3_6 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion3_6.value }}" onclick="changeColor(this, 'color_validacion3_6')">
                    {{ form.color_validacion3_6 }}
                </td>
                <td>{{ form.porque4_6 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion4_6.value }}" onclick="changeColor(this, 'color_validacion4_6')">
                    {{ form.color_validacion4_6 }}
                </td>
                <td>{{ form.porque5_6 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion5_6.value }}" onclick="changeColor(this, 'color_validacion5_6')">
                    {{ form.color_validacion5_6 }}
                </td>
                <td class="porque6-col" {% if not form.porque6_6.value %}style="display: none;"{% endif %}>{{ form.porque6_6 }}</td>
                <td class="color-cell validacion6-col" {% if not form.porque6_6.value %}style="display: none;"{% endif %} data-color="{{ form.color_validacion6_6.value }}" onclick="changeColor(this, 'color_validacion6_6')">
                    {{ form.color_validacion6_6 }}
                </td>
                <td class="porque7-col" {% if not form.porque7_6.value %}style="display: none;"{% endif %}>{{ form.porque7_6 }}</td>
                <td class="color-cell validacion7-col" {% if not form.porque7_6.value %}style="display: none;"{% endif %} data-color="{{ form.color_validacion7_6.value }}" onclick="changeColor(this, 'color_validacion7_6')">
                    {{ form.color_validacion7_6 }}
                </td>
                <td>{{ form.Raiz_6 }}</td>
            </tr>

            <tr id="porque-row-7" style="display: none;">
                <td>{{ form.modo_falla_paso3_7 }}</td>
                <td>{{ form.porque1_7 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion1_7.value }}" onclick="changeColor(this, 'color_validacion1_7')">
                    {{ form.color_validacion1_7 }}
                </td>
                <td>{{ form.porque2_7 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion2_7.value }}" onclick="changeColor(this, 'color_validacion2_7')">
                    {{ form.color_validacion2_7 }}
                </td>
                <td>{{ form.porque3_7 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion3_7.value }}" onclick="changeColor(this, 'color_validacion3_7')">
                    {{ form.color_validacion3_7 }}
                </td>
                <td>{{ form.porque4_7 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion4_7.value }}" onclick="changeColor(this, 'color_validacion4_7')">
                    {{ form.color_validacion4_7 }}
                </td>
                <td>{{ form.porque5_7 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion5_7.value }}" onclick="changeColor(this, 'color_validacion5_7')">
                    {{ form.color_validacion5_7 }}
                </td>
                <td class="porque6-col" {% if not form.porque6_7.value %}style="display: none;"{% endif %}>{{ form.porque6_7 }}</td>
                <td class="color-cell validacion6-col" {% if not form.porque6_7.value %}style="display: none;"{% endif %} data-color="{{ form.color_validacion6_7.value }}" onclick="changeColor(this, 'color_validacion6_7')">
                    {{ form.color_validacion6_7 }}
                </td>
                <td class="porque7-col" {% if not form.porque7_7.value %}style="display: none;"{% endif %}>{{ form.porque7_7 }}</td>
                <td class="color-cell validacion7-col" {% if not form.porque7_7.value %}style="display: none;"{% endif %} data-color="{{ form.color_validacion7_7.value }}" onclick="changeColor(this, 'color_validacion7_7')">
                    {{ form.color_validacion7_7 }}
                </td>
                <td>{{ form.Raiz_7 }}</td>
            </tr>

            <tr id="porque-row-8" style="display: none;">
                <td>{{ form.modo_falla_paso3_8 }}</td>
                <td>{{ form.porque1_8 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion1_8.value }}" onclick="changeColor(this, 'color_validacion1_8')">
                    {{ form.color_validacion1_8 }}
                </td>
                <td>{{ form.porque2_8 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion2_8.value }}" onclick="changeColor(this, 'color_validacion2_8')">
                    {{ form.color_validacion2_8 }}
                </td>
                <td>{{ form.porque3_8 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion3_8.value }}" onclick="changeColor(this, 'color_validacion3_8')">
                    {{ form.color_validacion3_8 }}
                </td>
                <td>{{ form.porque4_8 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion4_8.value }}" onclick="changeColor(this, 'color_validacion4_8')">
                    {{ form.color_validacion4_8 }}
                </td>
                <td>{{ form.porque5_8 }}</td>
                <td class="color-cell" data-color="{{ form.color_validacion5_8.value }}" onclick="changeColor(this, 'color_validacion5_8')">
                    {{ form.color_validacion5_8 }}
                </td>
                <td class="porque6-col" {% if not form.porque6_8.value %}style="display: none;"{% endif %}>{{ form.porque6_8 }}</td>
                <td class="color-cell validacion6-col" {% if not form.porque6_8.value %}style="display: none;"{% endif %} data-color="{{ form.color_validacion6_8.value }}" onclick="changeColor(this, 'color_validacion6_8')">
                    {{ form.color_validacion6_8 }}
                </td>
                <td class="porque7-col" {% if not form.porque7_8.value %}style="display: none;"{% endif %}>{{ form.porque7_8 }}</td>
                <td class="color-cell validacion7-col" {% if not form.porque7_8.value %}style="display: none;"{% endif %} data-color="{{ form.color_validacion7_8.value }}" onclick="changeColor(this, 'color_validacion7_8')">
                    {{ form.color_validacion7_8 }}
                </td>
                <td>{{ form.Raiz_8 }}</td>
            </tr>

        </table>
    </div>
</div>

<script>
    // Función para cambiar el color de las celdas
    function changeColor(cell, inputId) {
        const colors = ['white', 'green', 'red'];
        let currentColor = cell.getAttribute('data-color');
        let nextColorIndex = (colors.indexOf(currentColor) + 1) % colors.length;
        let nextColor = colors[nextColorIndex];

        // Cambiar el color de fondo de la celda
        cell.style.backgroundColor = nextColor;
        cell.setAttribute('data-color', nextColor);

        // Actualizar el valor en el campo de formulario oculto
        document.getElementById('id_' + inputId).value = nextColor;

        // Actualizar el estado del checkbox de validación si existe
        let checkboxId = inputId.replace('color_validacion', 'validado');
        let checkbox = document.getElementById('id_' + checkboxId);
        if (checkbox) {
            checkbox.checked = (nextColor === 'green');
        }
    }

    // Restaurar los colores iniciales basados en los valores almacenados
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.color-cell').forEach(cell => {
            let savedColor = cell.getAttribute('data-color');
            if (savedColor) {
                cell.style.backgroundColor = savedColor;  // Restaurar el color de la celda
            }
        });

        let totalRows = 8;  // Número total de filas
        let currentRow = 1;  // Filas visibles inicialmente
        let porqueCount = 5; // Comenzamos con 5 columnas de "¿POR QUÉ?"

        // Función para ocultar filas sin datos en las columnas "¿POR QUÉ?"
        function manageRows() {
            for (let i = 2; i <= totalRows; i++) {
                let row = document.getElementById(`porque-row-${i}`);
                
                // Solo verificar las columnas "¿POR QUÉ?" (No validación)
                let porqueInputs = row.querySelectorAll('[id^="id_porque"]'); // Busca campos de las columnas "¿POR QUÉ?"
                let hasPorqueData = Array.from(porqueInputs).some(input => input.value.trim() !== ""); // Verifica si algún campo "¿POR QUÉ?" tiene valor

                // Mostrar la fila si tiene datos en alguna columna "¿POR QUÉ?"
                if (hasPorqueData) {
                    row.style.display = '';  // Mostrar la fila con datos
                    currentRow = i;  // Actualizar el número de la última fila visible
                } else {
                    row.style.display = 'none';  // Ocultar la fila sin datos
                }
            }
        }

        // Mostrar las filas que tienen datos al cargar la página
        manageRows();

        // Función para verificar y mostrar columnas 6 y 7 si tienen información
        function checkAndShowColumns() {
            let showPorque6 = false;
            let showPorque7 = false;

            for (let i = 1; i <= totalRows; i++) {
                const porque6 = document.querySelector(`#porque-row-${i} .porque6-col`);
                const porque7 = document.querySelector(`#porque-row-${i} .porque7-col`);
                
                const porque6Input = porque6 ? porque6.querySelector('[id^="id_porque"]') : null; // Solo verificar campos "¿POR QUÉ?"
                const porque7Input = porque7 ? porque7.querySelector('[id^="id_porque"]') : null; // Solo verificar campos "¿POR QUÉ?"

                // Verificar si hay datos en la columna 6
                if (porque6Input && porque6Input.value.trim() !== '') {
                    showPorque6 = true;
                    porque6.style.display = '';  // Mostrar la columna 6 en todas las filas
                }

                // Verificar si hay datos en la columna 7
                if (porque7Input && porque7Input.value.trim() !== '') {
                    showPorque7 = true;
                    porque7.style.display = '';  // Mostrar la columna 7 en todas las filas
                }
            }

            // Mostrar la columna 6 si hay datos en alguna fila
            if (showPorque6) {
                document.querySelectorAll('.porque6-col').forEach(col => col.style.display = '');
                document.querySelectorAll('.validacion6-col').forEach(col => col.style.display = '');
                porqueCount = 6;
            }

            // Mostrar la columna 7 si hay datos en alguna fila
            if (showPorque7) {
                document.querySelectorAll('.porque7-col').forEach(col => col.style.display = '');
                document.querySelectorAll('.validacion7-col').forEach(col => col.style.display = '');
                porqueCount = 7;
            }

            // Ajustar el botón de agregar columnas
            const addPorqueBtn = document.getElementById('addPorqueBtn');
            if (porqueCount >= 7) {
                addPorqueBtn.style.display = 'none';
            } else if (porqueCount === 6) {
                addPorqueBtn.textContent = 'Agregar POR QUÉ? (7)';
            }
        }

        // Verificar y mostrar las columnas 6 y 7 al cargar la página
        checkAndShowColumns();

        // Botón para mostrar más filas
        const showMoreRowsBtn = document.getElementById('showMoreRows');

        showMoreRowsBtn.addEventListener('click', function() {
            currentRow++;
            const nextRow = document.getElementById(`porque-row-${currentRow}`);
            if (nextRow) {
                nextRow.style.display = ''; // Mostrar la siguiente fila oculta
            }

            // Si ya llegamos al total de filas, ocultar el botón
            if (currentRow >= totalRows) {
                showMoreRowsBtn.style.display = 'none';
            }
        });

        // Evento para agregar más "¿POR QUÉ?" columnas
        const addPorqueBtn = document.getElementById('addPorqueBtn');
        addPorqueBtn.addEventListener('click', function() {
            if (porqueCount < 7) {
                porqueCount++;
                const porqueCol = document.querySelectorAll(`.porque${porqueCount}-col`);
                const validacionCol = document.querySelectorAll(`.validacion${porqueCount}-col`);

                porqueCol.forEach(col => col.style.display = '');
                validacionCol.forEach(col => col.style.display = '');

                if (porqueCount === 6) {
                    addPorqueBtn.textContent = 'Agregar POR QUÉ? (7)';
                } else if (porqueCount === 7) {
                    addPorqueBtn.style.display = 'none';
                }
            }
        });

    });

    document.addEventListener("DOMContentLoaded", function() {
        const modoFallaPaso2 = document.getElementById("id_modo_falla_paso2");
        const modoFallaPaso3 = document.getElementById("id_modo_falla_paso3");

        // Verificar que ambos campos existan
        if (modoFallaPaso2 && modoFallaPaso3) {
            // Copiar el valor del Paso 2 al Paso 3 al cargar la página
            modoFallaPaso3.value = modoFallaPaso2.value;

            // Escuchar cambios en el Paso 2 para actualizar automáticamente el Paso 3
            modoFallaPaso2.addEventListener('input', function() {
                modoFallaPaso3.value = modoFallaPaso2.value;
            });
        } else {
            console.error('Campos modo_falla_paso2 o modo_falla_paso3 no encontrados');
        }
    });
</script>







































        <!-- Sección Paso 4: Contramedidas y Seguimiento -->
        <div id="paso3-section" class="recuadro-paso mt-4" style="border: 1px solid #00C851;">
            <div class="paso-header" style="background-color: #00C851; color: white; padding: 10px 15px; border-radius: 5px;">
                <h2 class="collapsible" style="cursor: pointer; margin: 0;" onclick="toggleVisibility('contenido-paso4')">
                    <span style="margin-right: 10px;">&#x25BC;</span> Paso 4: Contramedidas y Seguimiento
                </h2>
            </div>
        </div>


        <!-- Sección Paso 5: Estandarización y Expansión -->
        <div id="paso3-section" class="recuadro-paso mt-4" style="border: 1px solid #D86B20;">
            <div class="paso-header" style="background-color: #D86B20; color: white; padding: 10px 15px; border-radius: 5px;">
                <h2 class="collapsible" style="cursor: pointer; margin: 0;" onclick="toggleVisibility('contenido-paso5')">
                    <span style="margin-right: 10px;">&#x25BC;</span> Paso 5: Estandarización y Expansión
                </h2>
            </div>
        </div>
        {% endif %} <!-- Este es el cierre del "if" que se abrió al principio -->

        <div class="form-actions">
            <button type="submit" class="btn btn-primary" name="seccion1">Guardar y Continuar</button>
        </div>
    </form>
</div>





<!-- Incluir Select2 y jQuery -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


<!-- Inicialización de Select2 y otros scripts -->
<script type="text/javascript">
    $(document).ready(function() {
        function formatState(state) {
            if (!state.id) {
                return state.text;
            }
            var email = $(state.element).data('email');
            var $state = $('<span><strong>' + state.text + '</strong><br/><small>' + email + '</small></span>');
            return $state;
        }

        $('#miembros_equipo').select2({
            placeholder: "Selecciona miembros del equipo",
            templateResult: formatState,
            templateSelection: formatState,
            allowClear: true
        });

        const mappings = {
            "Microbiología": {
                categoria: "CALIDAD",
                pilar: "Pilar Calidad",
                kpi_iceo: "Calidad de procesos"
            },
            "Break Down": {
                categoria: "OPINONA",
                pilar: "Pilar CA/MA",
                kpi_iceo: "OPINONA"
            }
        };

        function actualizarValoresForm(subcategoria) {
            if (mappings[subcategoria]) {
                $("#categoria").val(mappings[subcategoria].categoria);
                $("#pilar").val(mappings[subcategoria].pilar);
                $("#kpi_iceo").val(mappings[subcategoria].kpi_iceo);
            } else {
                $("#categoria").val('');
                $("#pilar").val('');
                $("#kpi_iceo").val('');
            }
        }

        $("#subcategoria").change(function() {
            const subcategoria = $(this).val();
            actualizarValoresForm(subcategoria);
        });

        var today = new Date();
        var day = ("0" + today.getDate()).slice(-2);
        var month = ("0" + (today.getMonth() + 1)).slice(-2);
        var todayFormatted = today.getFullYear() + "-" + month + "-" + day;
        $('#fecha_inicio').val(todayFormatted);
    });


    function toggleVisibility(id) {
    var content = document.getElementById(id);
    
    // Asegurarse de que el elemento existe antes de modificarlo
    if (content) {
        var icon = content.previousElementSibling.querySelector('span');
        if (content.style.display === "none") {
            content.style.display = "block";
            if (icon) {
                icon.innerHTML = "&#x25BC;";  // Cambia el ícono a la flecha hacia abajo
            }
        } else {
            content.style.display = "none";
            if (icon) {
                icon.innerHTML = "&#x25B6;";  // Cambia el ícono a la flecha hacia la derecha
            }
        }
    } else {
        console.error("Elemento no encontrado: " + id);
    }
}

    // Por defecto, hacer que el contenido esté colapsado al cargar la página
    document.addEventListener("DOMContentLoaded", function() {
        toggleVisibility('contenido-paso1');
        toggleVisibility('contenido-paso2');
        toggleVisibility('contenido-paso3');
        toggleVisibility('contenido-paso4');
        toggleVisibility('contenido-paso5');
    });




    function toggleVisibility(id) {
        var element = document.getElementById(id);
        var icon = element.previousElementSibling.querySelector('span');
        if (element.style.display === "none") {
            element.style.display = "block";
            icon.innerHTML = "▼";
        } else {
            element.style.display = "none";
            icon.innerHTML = "▶";
        }
    }



    document.getElementById("togglePorque6").addEventListener("click", function() {
        var porque6Header = document.getElementById("porque6-header");
        var porque6Validacion = document.getElementById("porque6-validacion");
        var porque6Cells = document.querySelectorAll(".porque6-cell, .porque6-validacion-cell");
        var bloqueExtra = document.getElementById("bloque-extra");

        if (porque6Header.style.display === "none") {
            porque6Header.style.display = "table-cell";
            porque6Validacion.style.display = "table-cell";
            porque6Cells.forEach(cell => cell.style.display = "table-cell");
            bloqueExtra.style.display = "block";
            this.textContent = "Ocultar ¿POR QUÉ? (6)";
        } else {
            porque6Header.style.display = "none";
            porque6Validacion.style.display = "none";
            porque6Cells.forEach(cell => cell.style.display = "none");
            bloqueExtra.style.display = "none";
            this.textContent = "Agregar ¿POR QUÉ? (6)";
        }
    });


    // Por defecto, hacer que el contenido esté colapsado al cargar la página
    document.addEventListener("DOMContentLoaded", function() {
        toggleVisibility('contenido-paso3');
    });

    function cambiarColor(celda) {
        if (celda.style.backgroundColor === 'white' || celda.style.backgroundColor === '') {
            celda.style.backgroundColor = '#28a745';  // Verde para validado
        } else if (celda.style.backgroundColor === 'rgb(40, 167, 69)') {
            celda.style.backgroundColor = '#dc3545';  // Rojo para no válido
        } else {
            celda.style.backgroundColor = 'white';  // Blanco para no validado
        }
    }

    // Restaurar el color basado en el valor de los checkboxes
    document.addEventListener("DOMContentLoaded", function() {
        var validado1 = document.getElementById("id_validado1").checked;
        var validado2 = document.getElementById("id_validado2").checked;
        var validado3 = document.getElementById("id_validado3").checked;
        var validado4 = document.getElementById("id_validado4").checked;
        var validado5 = document.getElementById("id_validado5").checked;

        if (validado1) document.querySelector(".validacion-celda-1").style.backgroundColor = '#28a745';
        if (validado2) document.querySelector(".validacion-celda-2").style.backgroundColor = '#28a745';
        if (validado3) document.querySelector(".validacion-celda-3").style.backgroundColor = '#28a745';
        if (validado4) document.querySelector(".validacion-celda-4").style.backgroundColor = '#28a745';
        if (validado5) document.querySelector(".validacion-celda-5").style.backgroundColor = '#28a745';
    });


</script> 

{% endblock %}
